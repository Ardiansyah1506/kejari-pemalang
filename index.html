<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>WhatsApp API with QR Code</title>
</head>
<body>
   <h1>WhatsApp Connection</h1>
   <button id="login-btn" style="display: block;">Login</button>
   <button id="logout-btn">Logout</button>
   <img id="qr-code" alt="QR Code will appear here" style="width: 300px; display: none;">
   <div id="status"></div>

   <h2>Send Message</h2>
   <form id="send-message-form">
      <label for="phoneNumber">Phone Number:</label>
      <input type="text" id="phoneNumber" name="phoneNumber" required>
      <br>
      <label for="message">Message:</label>
      <input type="text" id="message" name="message" required>
      <button type="submit">Send</button>
   </form>

   <script>
      let ws;
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const qrCodeImg = document.getElementById('qr-code');
      const statusDiv = document.getElementById('status');

      // Cek status WhatsApp apakah sudah login atau belum
      async function checkWhatsAppStatus() {
         try {
            const response = await fetch('https://express-wa-api-production.up.railway.app/status');
            const result = await response.json();

            if (result.isLoggedIn) {
               // Jika sudah login
               statusDiv.textContent = 'WhatsApp is connected';
               loginBtn.style.display = 'none';
               logoutBtn.style.display = 'block';
            } else {
               // Jika belum login
               statusDiv.textContent = 'WhatsApp is not connected';
               loginBtn.style.display = 'block';
               logoutBtn.style.display = 'none';
            }
         } catch (error) {
            console.error('Error checking WhatsApp status:', error);
         }
      }

      // Fungsi untuk memulai WebSocket jika WhatsApp belum login
      function startWebSocket() {
         ws = new WebSocket('wss://express-wa-api-production.up.railway.app');
         ws.onmessage = (event) => {
            try {
               const data = JSON.parse(event.data);
               console.log("Received data: ", data);

               // Tampilkan QR Code jika tersedia
               if (data.qrCode) {
                  qrCodeImg.src = data.qrCode;
                  qrCodeImg.style.display = 'block';
               }

               // Update status
               if (data.status) {
                  statusDiv.textContent = data.status;

                  if (data.status === 'WhatsApp connected') {
                     loginBtn.style.display = 'none';
                     logoutBtn.style.display = 'block';
                     qrCodeImg.style.display = 'none'; // Sembunyikan QR setelah login
                     ws.close(); // Tutup WebSocket setelah login
                  }
               }
            } catch (e) {
               console.error('Error parsing WebSocket message', e);
            }
         };
      }

      // Event login
      loginBtn.addEventListener('click', async () => {
         statusDiv.textContent = 'Connecting to WhatsApp...';
         await fetch('https://express-wa-api-production.up.railway.app/connect'); // Mulai proses koneksi
         startWebSocket(); // Mulai WebSocket untuk mendapatkan QR code
      });

      // Event logout
      logoutBtn.addEventListener('click', async () => {
         const response = await fetch('https://express-wa-api-production.up.railway.app/logout', {
            method: 'POST',
         });

         const result = await response.json();
         alert(result.message);

         // Reset UI setelah logout
         loginBtn.style.display = 'block';
         logoutBtn.style.display = 'none';
         qrCodeImg.style.display = 'none';
         statusDiv.textContent = 'WhatsApp is not connected';
      });

      // Form untuk mengirim pesan WhatsApp
      const form = document.getElementById('send-message-form');
      form.addEventListener('submit', async (event) => {
         event.preventDefault();

         const phoneNumber = document.getElementById('phoneNumber').value;
         const message = document.getElementById('message').value;

         try {
            const response = await fetch('https://express-wa-api-production.up.railway.app/send-message', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({ phoneNumber, message }),
            });

            const result = await response.json();
            alert(result.status || result.message);
         } catch (error) {
            alert('Error sending message');
         }
      });

      // Cek status WhatsApp ketika halaman dimuat
      checkWhatsAppStatus();
   </script>
</body>
</html>
